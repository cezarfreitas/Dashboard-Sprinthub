# REGRA GERAL: SCHEMA DO BANCO DE DADOS

**‚ö†Ô∏è CR√çTICO - SEMPRE CONSULTAR ANTES DE QUALQUER OPERA√á√ÉO SQL:**

Antes de escrever qualquer query SQL, criar/modificar APIs que interajam com banco de dados, ou fazer refer√™ncia a tabelas/campos do MySQL, **OBRIGATORIAMENTE** consultar o arquivo `banco.sql` na raiz do projeto.

**Tabelas dispon√≠veis:**
- `colunas_funil` - Colunas dos funis de vendas
- `configuracoes` - Configura√ß√µes gerais do sistema
- `cron_sync_history` - Hist√≥rico de sincroniza√ß√µes agendadas
- `fila_leads_log` - Log de distribui√ß√£o de leads na fila rotativa
- `funis` - Funis de vendas
- `metas_mensais` - Metas mensais dos vendedores
- `motivos_de_perda` - Motivos de perda de oportunidades
- `notificacao_oportunidades` - Notifica√ß√µes de novas oportunidades
- `oportunidades` - Oportunidades de vendas
- `unidades` - Unidades/departamentos
- `unidade_grupos` - Grupos de unidades
- `usuarios_sistema` - Usu√°rios do sistema administrativo
- `vendedores` - Vendedores/usu√°rios do CRM

**Sempre verificar:**
- ‚úÖ Nomes exatos de colunas (case-sensitive)
- ‚úÖ Tipos de dados corretos (INT, VARCHAR, DECIMAL, JSON, etc.)
- ‚úÖ Foreign keys e relacionamentos entre tabelas
- ‚úÖ √çndices dispon√≠veis para otimiza√ß√£o de queries
- ‚úÖ Constraints (UNIQUE, NOT NULL, etc.)

**Nunca:**
- ‚ùå Assumir nomes de colunas sem verificar
- ‚ùå Criar queries com campos inexistentes
- ‚ùå Fazer JOIN com tabelas que n√£o existem
- ‚ùå Usar tipos de dados incompat√≠veis

---

# REGRA: OTIMIZA√á√ÉO COMPLETA DE P√ÅGINA

Quando solicitado "otimize esta p√°gina", "@[caminho]" ou an√°lise de rota espec√≠fica, execute:

---

## 1. IDENTIFICAR E CORRIGIR BUGS

**Prioridade CR√çTICA:**
- ‚ùå SQL Injection vulnerabilities
- ‚ùå N+1 query problems
- ‚ùå Race conditions e memory leaks
- ‚ùå Event handlers incorretos ou duplicados
- ‚ùå Estados inconsistentes ou n√£o sincronizados

**Prioridade ALTA:**
- ‚ùå Erros de tipagem TypeScript
- ‚ùå Null/undefined n√£o tratados
- ‚ùå Promises n√£o aguardadas (missing await)
- ‚ùå Error handling silencioso (catch vazio)
- ‚ùå Valida√ß√£o de entrada faltando

**Prioridade M√âDIA:**
- ‚ùå Depend√™ncias faltando em useEffect/useCallback
- ‚ùå Keys inadequadas em listas
- ‚ùå Debounce n√£o implementado em buscas

---

## 2. LIMPAR C√ìDIGO

**Obrigat√≥rio:**
- üßπ Remover TODOS console.logs/console.error/console.warn
- üßπ Eliminar c√≥digo comentado
- üßπ Remover imports n√£o utilizados
- üßπ Eliminar duplica√ß√µes de c√≥digo
- üßπ Organizar imports: React ‚Üí Next.js ‚Üí Libs externas ‚Üí Locais

**Padroniza√ß√£o:**
- camelCase: vari√°veis, fun√ß√µes
- PascalCase: componentes, types, interfaces
- UPPER_CASE: constantes globais
- kebab-case: arquivos (exceto componentes)

---

## 3. OTIMIZAR PERFORMANCE

**React Memoization:**
```typescript
// Componentes que recebem props
export const Component = memo(function Component({ prop }) { ... })

// C√°lculos pesados ou deriva√ß√µes
const expensiveValue = useMemo(() => compute(data), [data])

// Fun√ß√µes passadas como props
const handleClick = useCallback(() => action(), [deps])
```

**API Optimization:**
- ‚ö° Batch queries: N queries ‚Üí 1 query com JOIN/GROUP BY
- ‚ö° Otimizar N+1: buscar todos de uma vez, mapear em mem√≥ria
- ‚ö° Usar √≠ndices apropriados no banco
- ‚ö° SELECT espec√≠fico (n√£o SELECT *)

**Frontend Optimization:**
- ‚ö° Debounce (300ms) em inputs de busca
- ‚ö° AbortController para cancelar requests
- ‚ö° Evitar re-renders: mover estados para baixo
- ‚ö° Lazy loading: dynamic imports quando apropriado
- ‚ö° next/image para imagens

---

## 4. COMPONENTIZAR (ESTRUTURA FLEX√çVEL)

**Adaptar √† estrutura existente do projeto:**

### Se a p√°gina j√° tem estrutura modular:
```
app/[rota]/
‚îú‚îÄ‚îÄ page.tsx
‚îî‚îÄ‚îÄ components/         # Manter estrutura existente
    ‚îú‚îÄ‚îÄ Component1.tsx
    ‚îî‚îÄ‚îÄ Component2.tsx
```

### Se a p√°gina √© monol√≠tica (criar estrutura):
```
app/[rota]/
‚îî‚îÄ‚îÄ page.tsx           # Refatorar

Criar:
components/[rota]/     # Componentes isolados
‚îú‚îÄ‚îÄ [Rota]Card.tsx
‚îú‚îÄ‚îÄ [Rota]Filters.tsx
‚îú‚îÄ‚îÄ [Rota]List.tsx
‚îî‚îÄ‚îÄ [Rota]Dialog.tsx

hooks/[rota]/          # L√≥gica isolada
‚îî‚îÄ‚îÄ use[Rota].ts

types/ (opcional)
‚îî‚îÄ‚îÄ [rota].types.ts
```

**Regras de componentiza√ß√£o:**
- ‚úÖ Componentes < 250 linhas (guideline, n√£o regra r√≠gida)
- ‚úÖ Props tipadas com TypeScript
- ‚úÖ Separar UI de l√≥gica (hooks customizados)
- ‚úÖ Escopo isolado: zero conflitos com outras p√°ginas
- ‚úÖ Prefixar componentes com nome da rota (ex: VendedorRow, UnidadeCard)
- ‚ùå N√ÉO for√ßar componentiza√ß√£o prematura
- ‚ùå N√ÉO criar abstra√ß√µes gen√©ricas sem necessidade

**Quando N√ÉO componentizar:**
- Componente usado uma √∫nica vez
- Componente muito simples (< 50 linhas)
- L√≥gica intimamente acoplada

---

## 5. OTIMIZAR APIs (se aplic√°vel)

### Route Handlers (app/api/*/route.ts):

**Valida√ß√£o e Seguran√ßa:**
```typescript
// Validar e sanitizar inputs
const page = Math.max(1, parseInt(searchParams.get('page') || '1') || 1)
const limit = Math.min(1000, Math.max(1, parseInt(searchParams.get('limit') || '50') || 50))

// Usar prepared statements
const query = 'SELECT * FROM table WHERE id = ?'
await executeQuery(query, [id])

// LIMIT/OFFSET seguros (valores validados)
query += ` LIMIT ${limit} OFFSET ${offset}`
```

**Error Handling:**
```typescript
try {
  // Opera√ß√£o
  return NextResponse.json({ success: true, data })
} catch (error) {
  return NextResponse.json(
    { 
      success: false, 
      message: 'Mensagem amig√°vel',
      error: error instanceof Error ? error.message : 'Erro desconhecido'
    },
    { status: 500 }
  )
}
```

**Response Patterns:**
- 200: Sucesso
- 201: Criado
- 400: Bad request (valida√ß√£o)
- 404: Not found
- 500: Server error

### Server Actions:
```typescript
'use server'

export async function myAction(data: FormData) {
  try {
    // Valida√ß√£o
    // Opera√ß√£o
    revalidatePath('/path')
    return { success: true }
  } catch (error) {
    return { success: false, error: 'message' }
  }
}
```

---

## 6. PADR√ïES DE C√ìDIGO

**TypeScript:**
- Strict mode habilitado
- Evitar `any` (usar `unknown` se necess√°rio)
- Interfaces exportadas para reutiliza√ß√£o
- Types inline para uso √∫nico

**Next.js/React:**
- Server Components por padr√£o
- "use client" apenas quando necess√°rio:
  - useState, useEffect, hooks
  - Event handlers (onClick, onChange)
  - Browser APIs
- Async/await (n√£o .then/.catch)

**Estiliza√ß√£o:**
- Tailwind CSS
- Classes organizadas: layout ‚Üí spacing ‚Üí colors ‚Üí typography
- Componentes shadcn/ui quando dispon√≠vel

---

## 7. TRATAMENTO DE ERROS E LOADING

**Loading States:**
```typescript
if (loading && data.length === 0) {
  return <Skeleton />
}
```

**Error States:**
```typescript
{error && (
  <Alert variant="destructive">
    <AlertDescription>{error}</AlertDescription>
  </Alert>
)}
```

**Empty States:**
```typescript
{data.length === 0 && !loading && (
  <EmptyState message="Nenhum item encontrado" />
)}
```

---

## 8. ACESSIBILIDADE B√ÅSICA

- Labels em todos inputs (`<label>` ou `aria-label`)
- Bot√µes descritivos (texto ou aria-label)
- Feedback visual: loading, errors, success
- Cores com contraste adequado
- Navega√ß√£o por teclado funcional

---

## ENTREGA OBRIGAT√ìRIA

Ao finalizar otimiza√ß√£o, fornecer:

1. **üìä Relat√≥rio de Bugs** (Markdown)
   - Bugs cr√≠ticos encontrados
   - Bugs m√©dios encontrados
   - Code smells corrigidos
   - Antes/Depois de cada corre√ß√£o

2. **‚ö° Relat√≥rio de Performance**
   - Queries antes/depois
   - Componentes memoizados
   - Otimiza√ß√µes implementadas
   - M√©tricas de impacto

3. **üìÅ Estrutura Final**
   - Arquivos criados
   - Arquivos refatorados
   - Arquivos removidos
   - √Årvore de diret√≥rios

4. **‚úÖ Checklist de Qualidade**
   - [ ] Zero console.logs
   - [ ] Zero c√≥digo comentado
   - [ ] Zero imports n√£o usados
   - [ ] Zero erros TypeScript
   - [ ] Error handling presente
   - [ ] Props tipadas
   - [ ] Performance otimizada
   - [ ] Race conditions corrigidas
   - [ ] Memory leaks corrigidas
   - [ ] SQL injection prevenida

---

## FLEXIBILIDADE CONTEXTUAL

**Adaptar √†s necessidades:**
- P√°ginas simples: menos componentiza√ß√£o
- P√°ginas complexas: mais componentiza√ß√£o
- APIs perform√°ticas: manter estrutura
- APIs problem√°ticas: refatorar completamente

**Priorizar:**
1. Bugs cr√≠ticos (seguran√ßa, data integrity)
2. Performance (N+1, memory leaks)
3. Manutenibilidade (componentiza√ß√£o, tipos)
4. DX (Developer Experience)

**Comunicar decis√µes:**
- Explicar por que componentizar ou n√£o
- Justificar escolhas de otimiza√ß√£o
- Documentar trade-offs

---

## EXEMPLO DE WORKFLOW

1. **An√°lise inicial**: Ler toda a p√°gina e APIs relacionadas
2. **Identificar problemas**: Bugs, performance, c√≥digo sujo
3. **Planejar refatora√ß√£o**: Decidir estrutura e componentes
4. **Executar**: Corrigir bugs ‚Üí Limpar ‚Üí Otimizar ‚Üí Componentizar
5. **Verificar**: Rodar checklist de qualidade
6. **Documentar**: Criar relat√≥rios completos

---

**IMPORTANTE:** 
- Zero conflitos com outras p√°ginas
- Isolamento total de componentes/hooks
- Manter compatibilidade com APIs existentes
- N√£o quebrar funcionalidades existentes
- Testar mentalmente cada mudan√ßa

